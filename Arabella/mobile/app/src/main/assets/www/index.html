<!DOCTYPE html>
<html>
<head>
    <title>POC</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
</head>
<body style="padding:0;margin:0">
<div id="map" style="height:100vh;width:100vw"></div>
</body>
<script>
    // Dodanie obiektu mapy
    var map = new ol.Map({
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      target: 'map',
      view: new ol.View({
        center: [0, 0],
        zoom: 2
      })
    });
    // Dodanie warstwy z punktami
    var currentPointsSource = new ol.source.Vector({
        features: []
    });
    var currentPointsLayer = new ol.layer.Vector({
        source: currentPointsSource,
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({color: 'red'}),
                    stroke: new ol.style.Stroke({
                    color: 'black', width: 2
                })
          })
        })
    });
    map.addLayer(currentPointsLayer);
    // Dodanie warstwy aktualnej pozycji
    var currentPositionSource = new ol.source.Vector({
        features: []
    });
    var currentPositionLayer = new ol.layer.Vector({
        source: currentPositionSource
    });
    map.addLayer(currentPositionLayer);
    // Dodanie linii
    var currentTrackSource = new ol.source.Vector({
        features: []
    });
    var currentTrackLayer = new ol.layer.Vector({
        source: currentTrackSource
    });
    map.addLayer(currentTrackLayer);
    // Dodanie flagi oznaczającej czy trwa rysowanie linii
    var isDrawing = false;
    // Funkcja odświeżania aktualnej pozycji
    function updateCurrentPosition(lat, lon) {
        map.getView().setCenter(ol.proj.fromLonLat([lon, lat]))
        map.getView().setZoom(18)
        /*
        Funkcja przyjmuje kolejno szerokość i długość geograficzną.
        Na przykład środek Poznania: updateCurrentPosition(52.4069200, 16.9299300)
        */
        // Czyszczenie źródła danych
        currentPositionSource.clear();
        // Dodanie punktu
        var featurePoint = new ol.Feature({
            geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])), // Geometria
        });
        currentPositionSource.addFeature(featurePoint);
        // Jeśl rysowanie to dodaj nowy punkt do ostatniego segmentu
        if(isDrawing === true) {
            // Ostatni segment
            var lastSegment = currentTrackSource.getFeatures()[currentTrackSource.getFeatures().length-1]
            // Edycja geometrii ostatniego segmentu
            lastSegment.setGeometry(new ol.geom.LineString(lastSegment.getGeometry().getCoordinates().concat([featurePoint.getGeometry().getCoordinates()])))
        };
    };
    // Funkcja startu rysowania linii podczas zmiany lokalizacji przez updateCurrentPosition
    function startDrawing() {
        /*
        Funkcja włącza rysowanie linii po lokalizacji
        */
        // Dodanie nowego segmentu z początkiem aktualnego położenia
        var featurePoint = new ol.Feature({
            geometry: new ol.geom.LineString([currentPositionSource.getFeatures()[0].getGeometry().getCoordinates()])
        });
        currentTrackSource.addFeature(featurePoint);
        // Oznaczenie rysowania
        isDrawing = true;
    };
    // Funkcja stopowania rysowania linii podczas zmiany lokalizacji przez updateCurrentPosition
    function stopDrawing() {
        /*
        Funkcja wyłącza rysowanie linii
        */
        isDrawing = false;
    };
    // Funkcja dodawania punktu podczas rysowania linii
    function addPoint(data) {
        // Dodaj punkt tylko podczas trackingu
        if(isDrawing == true) {
            /*
            Jeśli chcesz jakieś atrybuty przypisać to musisz tutaj wywołać coś do zebrania danych od usera (nazwa punktu np.)
            I jak już zbierzesz te dane, powiedzmy w postaci jsona, to wywołaj funkcję savePoint() z danymi punktu
            np. dane:

            var data = {
                nazwa: 'testowy punkt'
            }
            */
            var featurePoint = new ol.Feature({
                geometry: currentPositionSource.getFeatures()[0].clone().getGeometry() // Geometria
            });
            featurePoint.setProperties(data);
            currentPointsSource.addFeature(featurePoint);
            console.log(featurePoint.getProperties())
        }
    };

    // Funkcja eksportu warstwy do GeoJSON - w argumencie trzeba podać nazwę warstwy (nazwa zmiennej *cosTam*Layer)
    function exportToGeoJSON(layer) {
        /*
        Zmienna geojson zawiera string, który jest gotowy do sparsowania, tak jak zwykły JSON
        Współrzędne zapisywane są w układzie 3857, bo taki jest standardowy układ map internetowych.
        Jeśli potrzebujesz to czegoś jednak 4326 (czyli współrzędne geograficzne, np. 52.4069200, 16.9299300 to dawaj cyne)
        */
        var geojson = new ol.format.GeoJSON().writeFeatures(layer.getSource().getFeatures());
        //console.log(geojson)
        //return geojson;
        window.AndroidApp.GeoJSON_ToAndroid(geojson);
    }

    /*
    Testowy case:
    1. Lokalizacja w miejscu jeden
    2. Lokalizacja w miejscu dwa
    3. Włączenie rysowania
    4. Lokalizacja w miejscu jeden
    5. Wyłączenie rysowania
    6. Lokalizacja w miejscu trzy
    7. Włączenie rysowania
    8. Lokalizacja w miejscu jeden
    9. Wyłączenie rysowania
    10. Lokalizacja w miejscu cztery
    */
  </script>
</html>